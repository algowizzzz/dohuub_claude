generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum AddressType {
  HOME
  WORK
  DOCTOR
  PHARMACY
  OTHER
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAUSED
  EXPIRED
  CANCELLED
}

enum BookingStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DECLINED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SUSPENDED
  DELETED
}

enum ReportStatus {
  PENDING
  REVIEWED
  APPROVED
  REMOVED
}

enum ServiceCategory {
  CLEANING
  HANDYMAN
  BEAUTY
  GROCERIES
  RENTALS
  CAREGIVING
}

enum CleaningType {
  DEEP_CLEANING
  LAUNDRY
  OFFICE_CLEANING
}

enum HandymanType {
  PLUMBING
  ELECTRICAL
  INSTALLATION
  GENERAL_REPAIR
}

enum BeautyType {
  MAKEUP
  HAIR
  NAILS
  WELLNESS
}

enum CaregivingType {
  RIDE_ASSISTANCE
  COMPANIONSHIP_SUPPORT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================
// USER & AUTH MODELS
// ============================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  phone             String?
  firebaseUid       String?   @unique
  role              UserRole  @default(CUSTOMER)
  isEmailVerified   Boolean   @default(false)
  isPhoneVerified   Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  profile           UserProfile?
  addresses         Address[]
  paymentMethods    PaymentMethod[]
  bookings          Booking[]
  orders            Order[]
  reviews           Review[]
  reports           Report[]
  notifications     Notification[]
  pushTokens        PushToken[]
  chatConversations ChatConversation[]
  vendor            Vendor?

  @@index([email])
  @@index([firebaseUid])
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String
  lastName    String
  avatar      String?
  dateOfBirth DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Address {
  id          String      @id @default(cuid())
  userId      String
  type        AddressType @default(HOME)
  label       String
  street      String
  apartment   String?
  city        String
  state       String
  zipCode     String
  country     String      @default("USA")
  latitude    Float?
  longitude   Float?
  isDefault   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]
  orders   Order[]

  @@index([userId])
}

model PaymentMethod {
  id             String   @id @default(cuid())
  userId         String
  stripePaymentMethodId String @unique
  type           String   // card, bank_account
  last4          String
  brand          String?  // visa, mastercard, etc.
  expiryMonth    Int?
  expiryYear     Int?
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model OtpVerification {
  id        String   @id @default(cuid())
  email     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, otp])
}

// ============================================
// VENDOR MODELS
// ============================================

model Vendor {
  id                 String             @id @default(cuid())
  userId             String             @unique
  businessName       String
  description        String?
  logo               String?
  coverImage         String?
  contactEmail       String?
  contactPhone       String?
  isMichelle         Boolean            @default(false) // Platform owner's listings
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialStartedAt     DateTime           @default(now())
  trialEndsAt        DateTime?
  stripeAccountId    String?
  rating             Float              @default(0)
  reviewCount        Int                @default(0)
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceAreas      VendorServiceArea[]
  availability      VendorAvailability[]
  categories        VendorCategory[]
  cleaningListings  CleaningListing[]
  handymanListings  HandymanListing[]
  beautyListings    BeautyListing[]
  groceryListings   GroceryListing[]
  rentalListings    RentalListing[]
  caregivingListings CaregivingListing[]
  bookings          Booking[]
  orders            Order[]
  reviews           Review[]
  subscription      VendorSubscription?
  billingHistory    BillingHistory[]

  @@index([userId])
  @@index([isMichelle])
  @@index([subscriptionStatus])
}

model VendorCategory {
  id         String          @id @default(cuid())
  vendorId   String
  category   ServiceCategory
  isActive   Boolean         @default(true)
  createdAt  DateTime        @default(now())

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, category])
}

model VendorServiceArea {
  id        String   @id @default(cuid())
  vendorId  String
  name      String   // e.g., "Downtown Manhattan"
  zipCodes  String[] // Array of zip codes
  city      String
  state     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
}

model VendorAvailability {
  id           String   @id @default(cuid())
  vendorId     String
  dayOfWeek    Int      // 0-6 (Sunday-Saturday)
  startTime    String   // "09:00"
  endTime      String   // "17:00"
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, dayOfWeek])
}

model VendorSubscription {
  id                String             @id @default(cuid())
  vendorId          String             @unique
  stripeSubscriptionId String?
  status            SubscriptionStatus @default(TRIAL)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt        DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model BillingHistory {
  id           String   @id @default(cuid())
  vendorId     String
  amount       Float
  currency     String   @default("USD")
  description  String
  invoiceUrl   String?
  paidAt       DateTime?
  createdAt    DateTime @default(now())

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
}

// ============================================
// LISTING MODELS (Category-Specific)
// ============================================

// CLEANING SERVICES
model CleaningListing {
  id           String        @id @default(cuid())
  vendorId     String
  title        String
  description  String
  cleaningType CleaningType
  basePrice    Float
  priceUnit    String        @default("per_session") // per_hour, per_session
  images       String[]
  duration     Int?          // in minutes
  status       ListingStatus @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([vendorId])
  @@index([cleaningType])
  @@index([status])
}

// HANDYMAN SERVICES
model HandymanListing {
  id           String        @id @default(cuid())
  vendorId     String
  title        String
  description  String
  handymanType HandymanType
  basePrice    Float
  priceUnit    String        @default("per_hour")
  images       String[]
  status       ListingStatus @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([vendorId])
  @@index([handymanType])
  @@index([status])
}

// BEAUTY SERVICES
model BeautyListing {
  id          String        @id @default(cuid())
  vendorId    String
  title       String
  description String
  beautyType  BeautyType
  basePrice   Float
  duration    Int           // in minutes
  images      String[]
  portfolio   String[]      // Portfolio images
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([vendorId])
  @@index([beautyType])
  @@index([status])
}

// GROCERIES & FOOD
model GroceryListing {
  id          String        @id @default(cuid())
  vendorId    String
  name        String
  description String
  category    String        // Produce, Dairy, Bakery, etc.
  price       Float
  unit        String        @default("each") // each, lb, kg, etc.
  image       String?
  inStock     Boolean       @default(true)
  stockCount  Int?
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  vendor     Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([vendorId])
  @@index([category])
  @@index([status])
}

// RENTAL PROPERTIES
model RentalListing {
  id            String        @id @default(cuid())
  vendorId      String
  title         String
  description   String
  propertyType  String        // Apartment, House, Condo, Studio
  address       String
  city          String
  state         String
  zipCode       String
  latitude      Float?
  longitude     Float?
  bedrooms      Int
  bathrooms     Float
  amenities     String[]
  images        String[]
  pricePerNight Float?
  pricePerWeek  Float?
  pricePerMonth Float?
  minStay       Int           @default(1) // in days
  maxStay       Int?          // in days
  status        ListingStatus @default(ACTIVE)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  vendor       Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  availability RentalAvailability[]
  bookings     Booking[]

  @@index([vendorId])
  @@index([city, state])
  @@index([status])
}

model RentalAvailability {
  id        String   @id @default(cuid())
  listingId String
  date      DateTime
  isBooked  Boolean  @default(false)
  price     Float?   // Override price for this date

  listing RentalListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
}

// CAREGIVING SERVICES
model CaregivingListing {
  id             String         @id @default(cuid())
  vendorId       String
  title          String
  description    String
  caregivingType CaregivingType
  basePrice      Float
  priceUnit      String         @default("per_hour")
  serviceArea    String[]       // Covered zip codes
  images         String[]
  status         ListingStatus  @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([vendorId])
  @@index([caregivingType])
  @@index([status])
}

// ============================================
// BOOKING & ORDER MODELS
// ============================================

model Booking {
  id                  String          @id @default(cuid())
  userId              String
  vendorId            String
  addressId           String
  category            ServiceCategory
  
  // Polymorphic reference to listing
  cleaningListingId   String?
  handymanListingId   String?
  beautyListingId     String?
  rentalListingId     String?
  caregivingListingId String?
  
  scheduledDate       DateTime
  scheduledTime       String          // "10:00"
  endTime             String?         // For rentals/time-based
  duration            Int?            // in minutes
  
  // Caregiving specific
  pickupLocation      String?
  dropoffLocation     String?
  stops               String[]        // Additional stops
  isRoundTrip         Boolean         @default(false)
  
  specialInstructions String?
  subtotal            Float
  serviceFee          Float
  total               Float
  status              BookingStatus   @default(PENDING)
  
  completedAt         DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  user              User               @relation(fields: [userId], references: [id])
  vendor            Vendor             @relation(fields: [vendorId], references: [id])
  address           Address            @relation(fields: [addressId], references: [id])
  cleaningListing   CleaningListing?   @relation(fields: [cleaningListingId], references: [id])
  handymanListing   HandymanListing?   @relation(fields: [handymanListingId], references: [id])
  beautyListing     BeautyListing?     @relation(fields: [beautyListingId], references: [id])
  rentalListing     RentalListing?     @relation(fields: [rentalListingId], references: [id])
  caregivingListing CaregivingListing? @relation(fields: [caregivingListingId], references: [id])
  statusHistory     BookingStatusHistory[]
  transaction       Transaction?
  review            Review?

  @@index([userId])
  @@index([vendorId])
  @@index([status])
  @@index([scheduledDate])
}

model BookingStatusHistory {
  id        String        @id @default(cuid())
  bookingId String
  status    BookingStatus
  note      String?
  createdAt DateTime      @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

// ORDERS (for Groceries & Food)
model Order {
  id           String      @id @default(cuid())
  userId       String
  vendorId     String
  addressId    String
  subtotal     Float
  deliveryFee  Float
  serviceFee   Float
  total        Float
  status       OrderStatus @default(PENDING)
  specialNotes String?
  estimatedDelivery DateTime?
  deliveredAt  DateTime?
  cancelledAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user        User           @relation(fields: [userId], references: [id])
  vendor      Vendor         @relation(fields: [vendorId], references: [id])
  address     Address        @relation(fields: [addressId], references: [id])
  items       OrderItem[]
  transaction Transaction?

  @@index([userId])
  @@index([vendorId])
  @@index([status])
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  listingId String
  quantity  Int
  price     Float
  total     Float

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  listing GroceryListing @relation(fields: [listingId], references: [id])

  @@index([orderId])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  vendorId  String?    // Lock cart to one vendor
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String
  listingId String
  quantity  Int

  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, listingId])
}

// ============================================
// PAYMENT MODELS
// ============================================

model Transaction {
  id                    String        @id @default(cuid())
  bookingId             String?       @unique
  orderId               String?       @unique
  stripePaymentIntentId String?       @unique
  amount                Float
  platformFee           Float
  vendorPayout          Float
  currency              String        @default("USD")
  status                PaymentStatus @default(PENDING)
  paidAt                DateTime?
  refundedAt            DateTime?
  refundAmount          Float?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  booking Booking? @relation(fields: [bookingId], references: [id])
  order   Order?   @relation(fields: [orderId], references: [id])

  @@index([status])
}

// ============================================
// REVIEW & REPORT MODELS
// ============================================

model Review {
  id             String   @id @default(cuid())
  userId         String
  vendorId       String
  bookingId      String   @unique
  rating         Int      // 1-5
  comment        String?
  vendorResponse String?  // Vendor's reply to the review
  photos         String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  vendor  Vendor  @relation(fields: [vendorId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([vendorId])
  @@index([rating])
}

model Report {
  id           String       @id @default(cuid())
  userId       String
  listingType  String       // cleaning, handyman, beauty, etc.
  listingId    String
  reason       String
  comment      String?
  status       ReportStatus @default(PENDING)
  reviewedAt   DateTime?
  reviewedBy   String?      // Admin user ID
  resolution   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([listingType, listingId])
  @@index([status])
}

// ============================================
// NOTIFICATION & CHAT MODELS
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String
  type      String   // booking_update, order_update, promo, etc.
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   // ios, android, web
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatConversation {
  id        String        @id @default(cuid())
  userId    String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([userId])
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // user, assistant
  content        String
  metadata       Json?    // For service recommendations, etc.
  createdAt      DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

